<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ForgeNovaAI â€” Admin Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      color: #1f2937;
      line-height: 1.5;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .logo img {
      height: 40px;
      width: auto;
    }

    .nav {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .nav a {
      color: #6b7280;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav a:hover {
      color: #1f2937;
    }

    .nav a.active {
      color: #1f2937;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #6b7280;
    }

    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 40px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }

    .stat-value {
      font-size: 48px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .stat-value.error {
      color: #ff5e1e;
    }

    .stat-label {
      font-size: 15px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Section */
    .section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 28px;
      font-weight: 600;
      color: #1f2937;
    }

    .section-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .filter-dropdown {
      padding: 10px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      min-width: 140px;
    }

    .btn-primary {
      background: #ff5e1e;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #e55419;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 15px;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ff5e1e;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .actions-cell {
      display: flex;
      gap: 12px;
    }

    .action-link {
      color: #3b82f6;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .action-link:hover {
      text-decoration: underline;
    }

    .action-link.delete {
      color: #dc2626;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #f3f4f6;
      border-radius: 50%;
      border-top-color: #ff5e1e;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
        padding: 16px 20px;
      }

      .nav {
        flex-wrap: wrap;
        gap: 16px;
      }

      .container {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .section {
        padding: 20px;
      }

      .section-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <img src="assets/img/ForgeNova Final Logo.png" alt="ForgeNovaAI">
      </div>
      <nav class="nav">
        <a href="#" class="active" onclick="showSection('overview'); return false;">Overview</a>
        <a href="#" onclick="showSection('users'); return false;">Users</a>
        <a href="#" onclick="showSection('workspaces'); return false;">Workspaces</a>
        <a href="#" onclick="showSection('templates'); return false;">Templates</a>
        <a href="#" onclick="showSection('logs'); return false;">Logs</a>
        <a href="#" onclick="showSection('settings'); return false;">Settings</a>
      </nav>
    </div>
    <div class="header-right">
      <div class="admin-info">
        <span id="adminEmail"></span>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Overview Section -->
    <div id="section-overview" class="content-section">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalWorkspaces">-</div>
          <div class="stat-label">Total Workspaces</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeTemplates">-</div>
          <div class="stat-label">Active Templates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeJobs">-</div>
          <div class="stat-label">Active Jobs/Imports</div>
        </div>
        <div class="stat-card">
          <div class="stat-value error" id="erroredImports">-</div>
          <div class="stat-label">Errors/Failed Imports</div>
        </div>
      </div>

      <!-- Users Section in Overview -->
      <div class="section" style="margin-top: 32px;">
        <div class="section-header">
          <h2 class="section-title">Users</h2>
          <div class="section-actions">
            <select class="filter-dropdown" id="overviewStatusFilter" onchange="filterOverviewUsers()">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
            <button class="btn-primary" onclick="addUser()">Add User</button>
          </div>
        </div>

        <div id="overviewUsersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="section-users" class="content-section" style="display:none;">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Users</h2>
          <div class="section-actions">
            <select class="filter-dropdown" id="statusFilter" onchange="filterUsers()">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
            <button class="btn-primary" onclick="addUser()">Add User</button>
          </div>
        </div>

        <div id="usersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Workspaces Section -->
    <div id="section-workspaces" class="content-section" style="display:none;">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Workspaces</h2>
          <div class="section-actions">
            <button class="btn-primary">Add Workspace</button>
          </div>
        </div>
        <div style="padding:60px; text-align:center; color:#6b7280;">
          <p>Workspaces management coming soon...</p>
        </div>
      </div>
    </div>

    <!-- Templates Section -->
    <div id="section-templates" class="content-section" style="display:none;">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Templates</h2>
          <div class="section-actions">
            <button class="btn-primary">Add Template</button>
          </div>
        </div>
        <div style="padding:60px; text-align:center; color:#6b7280;">
          <p>Templates management coming soon...</p>
        </div>
      </div>
    </div>

    <!-- Logs Section -->
    <div id="section-logs" class="content-section" style="display:none;">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">System Logs</h2>
          <div class="section-actions">
            <select class="filter-dropdown">
              <option>All Logs</option>
              <option>Errors</option>
              <option>Warnings</option>
              <option>Info</option>
            </select>
          </div>
        </div>
        <div style="padding:60px; text-align:center; color:#6b7280;">
          <p>System logs coming soon...</p>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="section-settings" class="content-section" style="display:none;">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Settings</h2>
        </div>
        <div style="padding:60px; text-align:center; color:#6b7280;">
          <p>Settings management coming soon...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let currentFilter = '';

    // Navigation function
    function showSection(sectionName) {
      // Hide all sections
      const sections = document.querySelectorAll('.content-section');
      sections.forEach(section => {
        section.style.display = 'none';
      });

      // Show selected section
      const targetSection = document.getElementById('section-' + sectionName);
      if (targetSection) {
        targetSection.style.display = 'block';
      }

      // Update active nav link
      const navLinks = document.querySelectorAll('.nav a');
      navLinks.forEach(link => {
        link.classList.remove('active');
      });
      event.target.classList.add('active');

      // Load data if needed
      if (sectionName === 'users') {
        if (allUsers.length === 0) {
          fetchUsers(false);
        } else {
          renderUsers(allUsers, 'usersTableContainer');
        }
      }
    }

    // Logout function
    async function logout() {
      const token = localStorage.getItem('adminToken');
      if (token) {
        try {
          await fetch('/api/admin-logout', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
        } catch (e) {
          console.error('Logout error:', e);
        }
      }
      
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUser');
      window.location.href = '/admin-login.html';
    }

    // Check authentication
    async function checkAuth() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/admin-login.html';
        return false;
      }

      try {
        const resp = await fetch('/api/admin-verify', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();
        
        if (!json.ok || !json.isAdmin) {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          window.location.href = '/admin-login.html';
          return false;
        }
        
        // Display admin email
        if (json.user && json.user.email) {
          document.getElementById('adminEmail').textContent = json.user.email;
        }
        
        return true;
      } catch (e) {
        console.error('Auth check error:', e);
        window.location.href = '/admin-login.html';
        return false;
      }
    }

    // Fetch statistics
    async function fetchStats() {
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-stats', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await resp.json();
        
        if (data.ok) {
          document.getElementById('totalUsers').textContent = data.stats.totalUsers || 0;
          document.getElementById('totalWorkspaces').textContent = data.stats.totalWorkspaces || 0;
          document.getElementById('activeTemplates').textContent = data.stats.activeTemplates || 0;
          document.getElementById('activeJobs').textContent = data.stats.activeJobs || 0;
          document.getElementById('erroredImports').textContent = data.stats.erroredImports || 0;
        }
      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Fetch users
    async function fetchUsers(renderToOverview = false) {
      const token = localStorage.getItem('adminToken');
      const containerId = renderToOverview ? 'overviewUsersTableContainer' : 'usersTableContainer';
      
      try {
        const resp = await fetch('/api/admin-users', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await resp.json();
        
        if (data.ok) {
          allUsers = data.users || [];
          renderUsers(allUsers, containerId);
          
          // If rendering to overview, also update the users section if it was already loaded
          if (renderToOverview) {
            const usersContainer = document.getElementById('usersTableContainer');
            if (usersContainer && !usersContainer.querySelector('.loading')) {
              renderUsers(allUsers, 'usersTableContainer');
            }
          }
        } else {
          const container = document.getElementById(containerId);
          if (container) {
            container.innerHTML = '<div class="error-message">Failed to load users: ' + (data.error || 'Unknown error') + '</div>';
          }
        }
      } catch (e) {
        console.error('Failed to fetch users:', e);
        const container = document.getElementById(containerId);
        if (container) {
          container.innerHTML = '<div class="error-message">Network error loading users</div>';
        }
      }
    }

    // Render users table
    function renderUsers(users, containerId = 'usersTableContainer') {
      const container = document.getElementById(containerId);
      
      if (!container) return;
      
      if (users.length === 0) {
        container.innerHTML = '<div class="loading"><p>No users found</p></div>';
        return;
      }

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Company</th>
                <th>Role</th>
                <th>Status</th>
                <th>Signup Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      users.forEach(user => {
        const initials = getInitials(user.full_name || user.email);
        const statusClass = (user.status || 'pending').toLowerCase();
        const statusText = user.status || 'Pending';
        const signupDate = formatDate(user.created_at);
        const company = user.company || '-';
        const role = user.role || 'User';

        html += `
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar">${initials}</div>
                <span>${user.full_name || 'Unknown'}</span>
              </div>
            </td>
            <td>${user.email || '-'}</td>
            <td>${company}</td>
            <td>${capitalizeFirst(role)}</td>
            <td><span class="status-badge ${statusClass}">${capitalizeFirst(statusText)}</span></td>
            <td>${signupDate}</td>
            <td>
              <div class="actions-cell">
                <a href="#" class="action-link" onclick="resetPassword('${user.user_id}'); return false;">Reset Password</a>
                ${statusClass !== 'active' ? `<a href="#" class="action-link" onclick="activateUser('${user.user_id}'); return false;">Activate</a>` : ''}
                <a href="#" class="action-link delete" onclick="deleteUser('${user.user_id}'); return false;">Delete</a>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    // Filter users
    function filterUsers() {
      const filter = document.getElementById('statusFilter').value.toLowerCase();
      currentFilter = filter;
      
      if (filter === '') {
        renderUsers(allUsers, 'usersTableContainer');
      } else {
        const filtered = allUsers.filter(user => 
          (user.status || 'pending').toLowerCase() === filter
        );
        renderUsers(filtered, 'usersTableContainer');
      }
    }

    // Filter overview users
    function filterOverviewUsers() {
      const filter = document.getElementById('overviewStatusFilter').value.toLowerCase();
      
      if (filter === '') {
        renderUsers(allUsers, 'overviewUsersTableContainer');
      } else {
        const filtered = allUsers.filter(user => 
          (user.status || 'pending').toLowerCase() === filter
        );
        renderUsers(filtered, 'overviewUsersTableContainer');
      }
    }

    // Helper functions
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function capitalizeFirst(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    // User actions
    function addUser() {
      alert('Add User functionality - To be implemented');
    }

    async function resetPassword(userId) {
      if (!confirm('Send password reset email to this user?')) return;
      
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-reset-password', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        
        if (data.ok) {
          alert('Password reset email sent successfully');
        } else {
          alert('Failed to send reset email: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Network error: ' + e.message);
      }
    }

    async function activateUser(userId) {
      if (!confirm('Activate this user account?')) return;
      
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-activate-user', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        
        if (data.ok) {
          alert('User activated successfully');
          // Reload users in both views
          await fetchUsers(true);
        } else {
          alert('Failed to activate user: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Network error: ' + e.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
      
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-delete-user', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        
        if (data.ok) {
          alert('User deleted successfully');
          // Reload users in both views
          await fetchUsers(true);
        } else {
          alert('Failed to delete user: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Network error: ' + e.message);
      }
    }

    // Initialize
    (async function init() {
      const authenticated = await checkAuth();
      if (authenticated) {
        await fetchStats();
        // Load users for the overview page
        await fetchUsers(true);
      }
    })();
  </script>
</body>
</html>
