<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ForgeNovaAI — Admin Dashboard</title>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/assets/img/favicon.svg">
  <link rel="alternate icon" href="/assets/img/favicon-32.png">
  <link rel="apple-touch-icon" href="/assets/img/favicon-64.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      color: #1f2937;
      line-height: 1.5;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .logo img {
      height: 60px;
      width: auto;
    }

    .nav {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .nav a {
      color: #6b7280;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav a:hover {
      color: #1f2937;
    }

    .nav a.active {
      color: #1f2937;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #6b7280;
    }

    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }

    /* Main Content */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 40px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }

    .stat-value {
      font-size: 48px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .stat-value.error {
      color: #ff5e1e;
    }

    .stat-label {
      font-size: 15px;
      color: #6b7280;
      font-weight: 500;
    }

    /* Section */
    .section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 28px;
      font-weight: 600;
      color: #1f2937;
    }

    .section-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .filter-dropdown {
      padding: 10px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      min-width: 140px;
    }

    .btn-primary {
      background: #ff5e1e;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #e55419;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 15px;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ff5e1e;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .actions-cell {
      display: flex;
      gap: 12px;
    }

    .action-link {
      color: #3b82f6;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .action-link:hover {
      text-decoration: underline;
    }

    .action-link.delete {
      color: #dc2626;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #f3f4f6;
      border-radius: 50%;
      border-top-color: #ff5e1e;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Logs Section */
    .logs-description {
      font-size: 16px;
      color: #4b5563;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .logs-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .filter-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .filter-btn.active {
      background: #f3f4f6;
      color: #1f2937;
      font-weight: 600;
      border-color: #9ca3af;
    }

    .export-btn {
      padding: 10px 24px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
    }

    .export-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .log-level {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .log-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .log-icon.error {
      background: #dc2626;
    }

    .log-icon.warning {
      background: #f59e0b;
    }

    .log-icon.info {
      background: #3b82f6;
    }

    .log-icon.debug {
      background: #6b7280;
    }

    .log-level.error {
      color: #dc2626;
    }

    .log-level.warning {
      color: #f59e0b;
    }

    .log-level.info {
      color: #3b82f6;
    }

    .log-level.debug {
      color: #6b7280;
    }

    /* Workspaces Section */
    .workspaces-description {
      font-size: 16px;
      color: #4b5563;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .workspaces-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 32px;
      margin-top: 32px;
    }

    .workspaces-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .workspace-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 180px;
      display: flex;
      flex-direction: column;
    }

    .workspace-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .workspace-card.selected {
      border-color: #ff5e1e;
      background: #fff7f5;
    }

    .workspace-dots {
      display: flex;
      gap: 6px;
      margin-bottom: 40px;
    }

    .workspace-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #d1d5db;
    }

    .workspace-card.selected .workspace-dot {
      background: #ff5e1e;
    }

    .workspace-name {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .workspace-meta {
      font-size: 14px;
      color: #6b7280;
      margin-top: auto;
    }

    .workspace-detail {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 32px;
    }

    .workspace-detail-header {
      margin-bottom: 24px;
    }

    .workspace-detail-title {
      font-size: 32px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
    }

    .workspace-tabs {
      display: flex;
      gap: 32px;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .workspace-tab {
      padding: 12px 0;
      font-size: 16px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .workspace-tab:hover {
      color: #1f2937;
    }

    .workspace-tab.active {
      color: #ff5e1e;
      border-bottom-color: #ff5e1e;
      font-weight: 600;
    }

    .workspace-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 32px;
    }

    .workspace-stat {
      font-size: 16px;
      color: #1f2937;
    }

    .workspace-section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
    }

    .workspace-members {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 32px;
    }

    .workspace-member {
      font-size: 16px;
      color: #1f2937;
    }

    .workspace-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 32px;
    }

    .workspace-info-item {
      font-size: 16px;
      color: #1f2937;
    }

    .workspace-info-item .label {
      color: #6b7280;
    }

    .workspace-actions {
      display: flex;
      gap: 16px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    .workspace-action-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .workspace-action-btn.view {
      background: white;
      color: #3b82f6;
      border: 1px solid #3b82f6;
    }

    .workspace-action-btn.view:hover {
      background: #eff6ff;
    }

    .workspace-action-btn.suspend {
      background: white;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }

    .workspace-action-btn.suspend:hover {
      background: #f9fafb;
    }

    .workspace-action-btn.delete {
      background: white;
      color: #dc2626;
      border: 1px solid #dc2626;
    }

    .workspace-action-btn.delete:hover {
      background: #fef2f2;
    }

    .workspace-new-btn {
      position: absolute;
      top: 32px;
      right: 40px;
      background: #ff5e1e;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .workspace-new-btn:hover {
      background: #e55419;
    }

    .workspace-empty {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    /* Templates Section */
    .templates-description {
      font-size: 16px;
      color: #4b5563;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .templates-container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 32px;
      margin-top: 32px;
    }

    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .template-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 180px;
      display: flex;
      flex-direction: column;
    }

    .template-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .template-card.selected {
      border-color: #ff5e1e;
      background: #fff7f5;
    }

    .template-dots {
      display: flex;
      gap: 6px;
      margin-bottom: 40px;
    }

    .template-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #d1d5db;
    }

    .template-card.selected .template-dot {
      background: #ff5e1e;
    }

    .template-name {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .template-meta {
      font-size: 14px;
      color: #6b7280;
      margin-top: auto;
    }

    .template-detail {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 32px;
    }

    .template-detail-header {
      margin-bottom: 24px;
    }

    .template-detail-title {
      font-size: 32px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
    }

    .template-tabs {
      display: flex;
      gap: 32px;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .template-tab {
      padding: 12px 0;
      font-size: 16px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .template-tab:hover {
      color: #1f2937;
    }

    .template-tab.active {
      color: #ff5e1e;
      border-bottom-color: #ff5e1e;
      font-weight: 600;
    }

    .template-info-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 16px;
    }

    .template-info-label {
      color: #1f2937;
      font-weight: 500;
    }

    .template-info-value {
      color: #1f2937;
    }

    .template-section {
      margin-top: 32px;
      margin-bottom: 24px;
    }

    .template-section-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
    }

    .template-used-by {
      color: #1f2937;
      font-size: 16px;
      margin-bottom: 24px;
    }

    .template-used-for {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .template-tag {
      padding: 6px 16px;
      background: #f3f4f6;
      border-radius: 6px;
      font-size: 15px;
      color: #1f2937;
    }

    .template-actions {
      display: flex;
      gap: 16px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
      margin-top: 32px;
    }

    .template-action-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-action-btn.edit {
      background: white;
      color: #3b82f6;
      border: 1px solid #3b82f6;
    }

    .template-action-btn.edit:hover {
      background: #eff6ff;
    }

    .template-action-btn.duplicate {
      background: white;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }

    .template-action-btn.duplicate:hover {
      background: #f9fafb;
    }

    .template-action-btn.archive {
      background: white;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }

    .template-action-btn.archive:hover {
      background: #f9fafb;
    }

    .template-action-btn.delete {
      background: white;
      color: #dc2626;
      border: 1px solid #dc2626;
    }

    .template-action-btn.delete:hover {
      background: #fef2f2;
    }

    .template-new-btn {
      position: absolute;
      top: 32px;
      right: 40px;
      background: #ff5e1e;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .template-new-btn:hover {
      background: #e55419;
    }

    .template-empty {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    /* Settings Section */
    .settings-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 0;
      min-height: 600px;
    }

    .settings-sidebar {
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      padding: 0;
    }

    .settings-tab-btn {
      display: block;
      width: 100%;
      padding: 16px 24px;
      background: transparent;
      border: none;
      text-align: left;
      font-size: 16px;
      font-weight: 500;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .settings-tab-btn:hover {
      background: #f3f4f6;
    }

    .settings-tab-btn.active {
      background: white;
      border-left-color: #ff5e1e;
      color: #ff5e1e;
      font-weight: 600;
    }

    .settings-content {
      padding: 40px;
      background: white;
    }

    .settings-title {
      font-size: 36px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 32px;
    }

    .settings-form-group {
      margin-bottom: 24px;
    }

    .settings-label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .settings-input {
      width: 100%;
      max-width: 500px;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      color: #1f2937;
    }

    .settings-input:focus {
      outline: none;
      border-color: #ff5e1e;
    }

    .settings-select {
      width: 100%;
      max-width: 500px;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      color: #1f2937;
      background: white;
      cursor: pointer;
    }

    .settings-select:focus {
      outline: none;
      border-color: #ff5e1e;
    }

    .settings-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .settings-theme {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .theme-option:hover {
      border-color: #ff5e1e;
      background: #fff5f0;
    }

    .theme-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #ff5e1e;
      margin: 0;
    }

    .theme-option input[type="radio"]:checked ~ span {
      color: #ff5e1e;
      font-weight: 600;
    }

    .theme-option span {
      font-size: 16px;
      color: #1f2937;
      cursor: pointer;
      margin: 0;
      font-weight: 500;
    }

    .settings-save-btn {
      background: #ff5e1e;
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: background 0.2s;
    }

    .settings-save-btn:hover {
      background: #e55419;
    }

    .feature-flag-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .feature-flag-info h4 {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .feature-flag-info p {
      font-size: 14px;
      color: #6b7280;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #ff5e1e;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .role-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .role-info {
      flex: 1;
    }

    .role-name {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    .role-email {
      font-size: 14px;
      color: #6b7280;
    }

    .api-key-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .api-key-value {
      font-family: monospace;
      color: #6b7280;
      font-size: 14px;
      margin-top: 8px;
    }

    .api-key-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 8px;
    }

    .badge-prod {
      background: #fee;
      color: #c00;
    }

    .badge-dev {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .api-key-actions {
      display: flex;
      gap: 8px;
    }

    .btn-secondary {
      padding: 8px 16px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    .backup-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .backup-info span {
      display: block;
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    .version-info {
      background: #f9fafb;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .version-number {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: #d1fae5;
      color: #065f46;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
        padding: 16px 20px;
      }

      .nav {
        flex-wrap: wrap;
        gap: 16px;
      }

      .container {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .section {
        padding: 20px;
      }

      .section-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      .logs-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-buttons {
        width: 100%;
      }

      .export-btn {
        width: 100%;
      }

      .workspaces-container {
        grid-template-columns: 1fr;
      }

      .workspace-new-btn {
        position: static;
        width: 100%;
        margin-bottom: 20px;
      }

      .templates-container {
        grid-template-columns: 1fr;
      }

      .template-new-btn {
        position: static;
        width: 100%;
        margin-bottom: 20px;
      }

      .settings-layout {
        grid-template-columns: 1fr;
      }

      .settings-sidebar {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }

      .settings-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <img src="assets/img/forgenova-logo.png" alt="ForgeNovaAI">
      </div>
      <nav class="nav">
        <a href="#" class="active" onclick="showSection('overview'); return false;">Overview</a>
        <a href="#" onclick="showSection('users'); return false;">Users</a>
        <a href="#" onclick="showSection('workspaces'); return false;">Workspaces</a>
        <a href="#" onclick="showSection('templates'); return false;">Templates</a>
        <a href="#" onclick="showSection('logs'); return false;">Logs</a>
        <a href="#" onclick="showSection('settings'); return false;">Settings</a>
      </nav>
    </div>
    <div class="header-right">
      <div class="admin-info">
        <span id="adminEmail"></span>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Overview Section -->
    <div id="section-overview" class="content-section">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalWorkspaces">-</div>
          <div class="stat-label">Total Workspaces</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeTemplates">-</div>
          <div class="stat-label">Active Templates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeJobs">-</div>
          <div class="stat-label">Active Jobs/Imports</div>
        </div>
        <div class="stat-card">
          <div class="stat-value error" id="erroredImports">-</div>
          <div class="stat-label">Errors/Failed Imports</div>
        </div>
      </div>

      <!-- Users Section in Overview -->
      <div class="section" style="margin-top: 32px;">
        <div class="section-header">
          <h2 class="section-title">Users</h2>
          <div class="section-actions">
            <select class="filter-dropdown" id="overviewStatusFilter" onchange="filterOverviewUsers()">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
            <button class="btn-primary" onclick="addUser()">Add User</button>
          </div>
        </div>

        <div id="overviewUsersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="section-users" class="content-section" style="display:none;">
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Users</h2>
          <div class="section-actions">
            <select class="filter-dropdown" id="statusFilter" onchange="filterUsers()">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
            <button class="btn-primary" onclick="addUser()">Add User</button>
          </div>
        </div>

        <div id="usersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Workspaces Section -->
    <div id="section-workspaces" class="content-section" style="display:none;">
      <div class="section" style="position: relative;">
        <h2 class="section-title" style="margin-bottom: 16px;">Workspaces</h2>
        <p class="workspaces-description">
          Workspaces allow users to organize their factory apps into distinct groups.<br>
          Users can create new workspaces or manage existing ones as needed.
        </p>
        
        <button class="workspace-new-btn" onclick="createNewWorkspace()">New Workspace</button>
        
        <div class="workspaces-container">
          <!-- Workspace Cards -->
          <div class="workspaces-grid" id="workspacesGrid">
            <!-- Cards will be rendered here -->
          </div>
          
          <!-- Workspace Detail -->
          <div id="workspaceDetail">
            <!-- Detail will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Templates Section -->
    <div id="section-templates" class="content-section" style="display:none;">
      <div class="section" style="position: relative;">
        <h2 class="section-title" style="margin-bottom: 16px;">Templates</h2>
        <p class="templates-description">
          App templates provide a starting point for users building factory apps.<br>
          Administrators can create and manage templates from this page.
        </p>
        
        <button class="template-new-btn" onclick="createNewTemplate()">New Template</button>
        
        <div class="templates-container">
          <!-- Template Cards -->
          <div class="templates-grid" id="templatesGrid">
            <!-- Cards will be rendered here -->
          </div>
          
          <!-- Template Detail -->
          <div id="templateDetail">
            <!-- Detail will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Logs Section -->
    <div id="section-logs" class="content-section" style="display:none;">
      <div class="section">
        <h2 class="section-title" style="margin-bottom: 16px;">Logs</h2>
        <p class="logs-description">
          Activity logs provide detailed records of recent actions and events in the system.<br>
          Logs can be filtered by level and exported for external analysis.
        </p>
        
        <div class="logs-controls">
          <div class="filter-buttons">
            <button class="filter-btn active" data-level="all" onclick="filterLogs('all')">All Levels</button>
            <button class="filter-btn" data-level="error" onclick="filterLogs('error')">Error</button>
            <button class="filter-btn" data-level="warning" onclick="filterLogs('warning')">Warning</button>
            <button class="filter-btn" data-level="info" onclick="filterLogs('info')">Info</button>
            <button class="filter-btn" data-level="debug" onclick="filterLogs('debug')">Debug</button>
          </div>
          <button class="export-btn" onclick="exportLogs()">Export Logs</button>
        </div>

        <div id="logsTableContainer">
          <!-- Logs will be rendered here -->
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="section-settings" class="content-section" style="display:none;">
      <div class="section" style="padding: 0;">
        <div class="settings-layout">
          <!-- Settings Sidebar -->
          <div class="settings-sidebar">
            <button class="settings-tab-btn active" data-tab="general" onclick="switchSettingsTab('general')">General</button>
            <button class="settings-tab-btn" data-tab="features" onclick="switchSettingsTab('features')">Feature Flags</button>
            <button class="settings-tab-btn" data-tab="roles" onclick="switchSettingsTab('roles')">Access & Roles</button>
            <button class="settings-tab-btn" data-tab="notifications" onclick="switchSettingsTab('notifications')">Email & Notifications</button>
            <button class="settings-tab-btn" data-tab="api" onclick="switchSettingsTab('api')">API Keys</button>
            <button class="settings-tab-btn" data-tab="backup" onclick="switchSettingsTab('backup')">Backup & Restore</button>
            <button class="settings-tab-btn" data-tab="updates" onclick="switchSettingsTab('updates')">System Updates</button>
          </div>

          <!-- Settings Content -->
          <div id="settingsContent" class="settings-content">
            <!-- Content will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allUsers = [];
    let currentFilter = '';
    let allLogs = [];
    let currentLogFilter = 'all';
    let allWorkspaces = [];
    let selectedWorkspaceId = null;
    let currentWorkspaceTab = 'overview';
    let allTemplates = [];
    let selectedTemplateId = null;
    let currentTemplateTab = 'preview';
    let currentSettingsTab = 'general';
    let systemSettings = {
      company_name: 'ForgeNovaAI',
      company_logo: 'forgenova-logo.png',
      date_format: 'DD/MM/YYYY',
      theme: 'light',
      system_version: 'v1.2.0'
    };

    // Helper function for making authenticated API calls
    async function makeAPICall(endpoint, method = 'GET', body = null) {
      const token = localStorage.getItem('adminToken');
      const options = {
        method,
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      };
      
      if (body && method !== 'GET') {
        options.body = JSON.stringify(body);
      }
      
      try {
        const response = await fetch(endpoint, options);
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('API call failed:', error);
        return { ok: false, error: error.message };
      }
    }

    // Navigation function
    function showSection(sectionName) {
      // Hide all sections
      const sections = document.querySelectorAll('.content-section');
      sections.forEach(section => {
        section.style.display = 'none';
      });

      // Show selected section
      const targetSection = document.getElementById('section-' + sectionName);
      if (targetSection) {
        targetSection.style.display = 'block';
      }

      // Update active nav link
      const navLinks = document.querySelectorAll('.nav a');
      navLinks.forEach(link => {
        link.classList.remove('active');
      });
      event.target.classList.add('active');

      // Load data if needed
      if (sectionName === 'users') {
        if (allUsers.length === 0) {
          fetchUsers(false);
        } else {
          renderUsers(allUsers, 'usersTableContainer');
        }
      } else if (sectionName === 'logs') {
        if (allLogs.length === 0) {
          loadLogs();
        } else {
          renderLogs(allLogs);
        }
      } else if (sectionName === 'workspaces') {
        if (allWorkspaces.length === 0) {
          loadWorkspaces();
        } else {
          renderWorkspaces();
        }
      } else if (sectionName === 'templates') {
        if (allTemplates.length === 0) {
          loadTemplates();
        } else {
          renderTemplates();
        }
      } else if (sectionName === 'settings') {
        renderSettingsContent(currentSettingsTab);
      }
    }

    // Logout function
    async function logout() {
      const token = localStorage.getItem('adminToken');
      if (token) {
        try {
          await fetch('/api/admin-logout', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
        } catch (e) {
          console.error('Logout error:', e);
        }
      }
      
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUser');
      window.location.href = '/admin-login.html';
    }

    // Check authentication
    async function checkAuth() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = '/admin-login.html';
        return false;
      }

      try {
        const resp = await fetch('/api/admin-verify', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await resp.json();
        
        if (!json.ok || !json.isAdmin) {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          window.location.href = '/admin-login.html';
          return false;
        }
        
        // Display admin email
        if (json.user && json.user.email) {
          document.getElementById('adminEmail').textContent = json.user.email;
        }
        
        return true;
      } catch (e) {
        console.error('Auth check error:', e);
        window.location.href = '/admin-login.html';
        return false;
      }
    }

    // Fetch statistics
    async function fetchStats() {
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-stats', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await resp.json();
        
        if (data.ok) {
          document.getElementById('totalUsers').textContent = data.stats.totalUsers || 0;
          document.getElementById('totalWorkspaces').textContent = data.stats.totalWorkspaces || 0;
          document.getElementById('activeTemplates').textContent = data.stats.activeTemplates || 0;
          document.getElementById('activeJobs').textContent = data.stats.activeJobs || 0;
          document.getElementById('erroredImports').textContent = data.stats.erroredImports || 0;
        }
      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Fetch users
    async function fetchUsers(renderToOverview = false) {
      const token = localStorage.getItem('adminToken');
      const containerId = renderToOverview ? 'overviewUsersTableContainer' : 'usersTableContainer';
      
      try {
        const resp = await fetch('/api/admin-users', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await resp.json();
        
        if (data.ok) {
          allUsers = data.users || [];
          renderUsers(allUsers, containerId);
          
          // If rendering to overview, also update the users section if it was already loaded
          if (renderToOverview) {
            const usersContainer = document.getElementById('usersTableContainer');
            if (usersContainer && !usersContainer.querySelector('.loading')) {
              renderUsers(allUsers, 'usersTableContainer');
            }
          }
        } else {
          const container = document.getElementById(containerId);
          if (container) {
            container.innerHTML = '<div class="error-message">Failed to load users: ' + (data.error || 'Unknown error') + '</div>';
          }
        }
      } catch (e) {
        console.error('Failed to fetch users:', e);
        const container = document.getElementById(containerId);
        if (container) {
          container.innerHTML = '<div class="error-message">Network error loading users</div>';
        }
      }
    }

    // Render users table
    function renderUsers(users, containerId = 'usersTableContainer') {
      const container = document.getElementById(containerId);
      
      if (!container) return;
      
      if (users.length === 0) {
        container.innerHTML = '<div class="loading"><p>No users found</p></div>';
        return;
      }

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Company</th>
                <th>Role</th>
                <th>Status</th>
                <th>Signup Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      users.forEach(user => {
        const initials = getInitials(user.full_name || user.email);
        const statusClass = (user.status || 'pending').toLowerCase();
        const statusText = user.status || 'Pending';
        const signupDate = formatDate(user.created_at);
        const company = user.company || '-';
        const role = user.role || 'User';

        html += `
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar">${initials}</div>
                <span>${user.full_name || 'Unknown'}</span>
              </div>
            </td>
            <td>${user.email || '-'}</td>
            <td>${company}</td>
            <td>${capitalizeFirst(role)}</td>
            <td><span class="status-badge ${statusClass}">${capitalizeFirst(statusText)}</span></td>
            <td>${signupDate}</td>
            <td>
              <div class="actions-cell">
                <a href="#" class="action-link" onclick="resetPassword('${user.user_id}'); return false;">Reset Password</a>
                ${statusClass !== 'active' ? `<a href="#" class="action-link" onclick="activateUser('${user.user_id}'); return false;">Activate</a>` : ''}
                <a href="#" class="action-link delete" onclick="deleteUser('${user.user_id}'); return false;">Delete</a>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    // Filter users
    function filterUsers() {
      const filter = document.getElementById('statusFilter').value.toLowerCase();
      currentFilter = filter;
      
      if (filter === '') {
        renderUsers(allUsers, 'usersTableContainer');
      } else {
        const filtered = allUsers.filter(user => 
          (user.status || 'pending').toLowerCase() === filter
        );
        renderUsers(filtered, 'usersTableContainer');
      }
    }

    // Filter overview users
    function filterOverviewUsers() {
      const filter = document.getElementById('overviewStatusFilter').value.toLowerCase();
      
      if (filter === '') {
        renderUsers(allUsers, 'overviewUsersTableContainer');
      } else {
        const filtered = allUsers.filter(user => 
          (user.status || 'pending').toLowerCase() === filter
        );
        renderUsers(filtered, 'overviewUsersTableContainer');
      }
    }

    // Helper functions
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function capitalizeFirst(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    // User actions
    function addUser() {
      alert('Add User functionality - To be implemented');
    }

    async function resetPassword(userId) {
      if (!confirm('Send password reset email to this user?')) return;
      
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-reset-password', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        
        if (data.ok) {
          alert('Password reset email sent successfully');
        } else {
          alert('Failed to send reset email: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Network error: ' + e.message);
      }
    }

    async function activateUser(userId) {
      if (!confirm('Activate this user account?')) return;
      
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-activate-user', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        
        if (data.ok) {
          alert('User activated successfully');
          // Reload users in both views
          await fetchUsers(true);
        } else {
          alert('Failed to activate user: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Network error: ' + e.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
      
      const token = localStorage.getItem('adminToken');
      try {
        const resp = await fetch('/api/admin-delete-user', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId })
        });
        const data = await resp.json();
        
        if (data.ok) {
          alert('User deleted successfully');
          // Reload users in both views
          await fetchUsers(true);
        } else {
          alert('Failed to delete user: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Network error: ' + e.message);
      }
    }

    // Logs functionality
    async function loadLogs() {
      const result = await makeAPICall('/api/admin-logs');
      
      if (result.ok && result.logs && result.logs.length > 0) {
        allLogs = result.logs.map(log => ({
          id: log.id,
          level: log.level,
          message: log.message,
          user: log.user_email || 'System',
          time: new Date(log.created_at),
          timestamp: new Date(log.created_at).getTime()
        }));
        
        allLogs.sort((a, b) => b.timestamp - a.timestamp);
      } else {
        // Fallback to mock data
        allLogs = [
          {
            id: 1,
            level: 'error',
            message: 'Failed data import',
            user: 'Jane Doe admin.poc',
            time: new Date(Date.now() - 2 * 60 * 60 * 1000),
            timestamp: Date.now() - 2 * 60 * 60 * 1000
          },
          {
            id: 2,
            level: 'info',
            message: 'Admin role assigned',
            user: 'admin@forgenova.ai',
            time: new Date(Date.now() - 4 * 60 * 60 * 1000),
            timestamp: Date.now() - 4 * 60 * 60 * 1000
          }
        ];
        allLogs.sort((a, b) => b.timestamp - a.timestamp);
      }
      
      renderLogs(allLogs);
    }

    function renderLogs(logs) {
      const container = document.getElementById('logsTableContainer');
      
      if (!container) return;
      
      if (logs.length === 0) {
        container.innerHTML = '<div class="loading"><p>No logs found</p></div>';
        return;
      }

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>LEVEL</th>
                <th>MESSAGE</th>
                <th>USER</th>
                <th>TIME</th>
              </tr>
            </thead>
            <tbody>
      `;

      logs.forEach(log => {
        const timeAgo = formatTimeAgo(log.time);
        const icon = log.level === 'error' ? '!' : 
                     log.level === 'warning' ? '⚠' : 
                     log.level === 'info' ? 'i' : 
                     'D';

        html += `
          <tr>
            <td>
              <div class="log-level ${log.level}">
                <div class="log-icon ${log.level}">${icon}</div>
                ${capitalizeFirst(log.level)}
              </div>
            </td>
            <td>${log.message}</td>
            <td>${log.user}</td>
            <td>${timeAgo}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    async function filterLogs(level) {
      currentLogFilter = level;
      
      // Update active button
      const buttons = document.querySelectorAll('.filter-btn');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-level') === level) {
          btn.classList.add('active');
        }
      });
      
      // Fetch filtered logs from API
      const endpoint = level === 'all' ? '/api/admin-logs' : `/api/admin-logs?level=${level}`;
      const result = await makeAPICall(endpoint);
      
      if (result.ok && result.logs) {
        const logs = result.logs.map(log => ({
          id: log.id,
          level: log.level,
          message: log.message,
          user: log.user_email || 'System',
          time: new Date(log.created_at),
          timestamp: new Date(log.created_at).getTime()
        }));
        renderLogs(logs);
      } else {
        // Fallback to client-side filtering
        if (level === 'all') {
          renderLogs(allLogs);
        } else {
          const filtered = allLogs.filter(log => log.level === level);
          renderLogs(filtered);
        }
      }
    }

    function exportLogs() {
      const logsToExport = currentLogFilter === 'all' 
        ? allLogs 
        : allLogs.filter(log => log.level === currentLogFilter);
      
      if (logsToExport.length === 0) {
        alert('No logs to export');
        return;
      }
      
      // Create CSV content
      let csv = 'Level,Message,User,Time\n';
      logsToExport.forEach(log => {
        const timeStr = log.time.toISOString();
        csv += `"${log.level}","${log.message}","${log.user}","${timeStr}"\n`;
      });
      
      // Create download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `forgenova-logs-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function formatTimeAgo(date) {
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      
      if (seconds < 60) return 'Just now';
      
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + ' minute' + (minutes === 1 ? '' : 's') + ' ago';
      
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + ' hour' + (hours === 1 ? '' : 's') + ' ago';
      
      const days = Math.floor(hours / 24);
      if (days < 7) return days + ' day' + (days === 1 ? '' : 's') + ' ago';
      
      const weeks = Math.floor(days / 7);
      if (weeks < 4) return weeks + ' week' + (weeks === 1 ? '' : 's') + ' ago';
      
      const months = Math.floor(days / 30);
      return months + ' month' + (months === 1 ? '' : 's') + ' ago';
    }

    // Workspaces functionality
    async function loadWorkspaces() {
      const result = await makeAPICall('/api/admin-workspaces');
      
      if (result.ok && result.workspaces && result.workspaces.length > 0) {
        allWorkspaces = result.workspaces.map(ws => ({
          id: ws.id,
          name: ws.name,
          lastUsed: ws.last_used_at,
          totalApps: ws.total_apps || 0,
          activeTemplates: ws.active_templates || 0,
          members: (ws.workspace_members || []).map(m => ({
            name: m.profiles?.full_name || 'Unknown',
            role: m.role || 'Member'
          })),
          dataImports: ws.data_imports || 0,
          errors: ws.errors_count || 0,
          errorPeriod: 'last 60 days',
          status: ws.status || 'active'
        }));
        
        selectedWorkspaceId = allWorkspaces[0].id;
      } else {
        // Fallback to mock data if no real data or Supabase not configured
        allWorkspaces = [
          {
            id: 'mock-1',
            name: 'Workspace One',
            lastUsed: null,
            totalApps: 5,
            activeTemplates: 3,
            members: [
              { name: 'Ford Engineering', role: 'Admin' },
              { name: 'Jane Doe', role: 'Member' }
            ],
            dataImports: 1,
            errors: 12,
            errorPeriod: 'last 60 days',
            status: 'active'
          }
        ];
        selectedWorkspaceId = 'mock-1';
      }
      
      renderWorkspaces();
    }

    function renderWorkspaces() {
      const gridContainer = document.getElementById('workspacesGrid');
      
      if (!gridContainer) return;
      
      if (allWorkspaces.length === 0) {
        gridContainer.innerHTML = '<div class="workspace-empty"><p>No workspaces found. Create a new workspace to get started.</p></div>';
        return;
      }

      // Render workspace cards
      let cardsHtml = '';
      allWorkspaces.forEach(workspace => {
        const isSelected = workspace.id === selectedWorkspaceId;
        const lastUsedText = workspace.lastUsed 
          ? formatDate(workspace.lastUsed) 
          : 'never used';

        cardsHtml += `
          <div class="workspace-card ${isSelected ? 'selected' : ''}" onclick="selectWorkspace(${workspace.id})">
            <div class="workspace-dots">
              <div class="workspace-dot"></div>
              <div class="workspace-dot"></div>
              <div class="workspace-dot"></div>
            </div>
            <div class="workspace-name">${workspace.name}</div>
            <div class="workspace-meta">Last used: ${lastUsedText}</div>
          </div>
        `;
      });

      gridContainer.innerHTML = cardsHtml;

      // Render selected workspace detail
      renderWorkspaceDetail();
    }

    function renderWorkspaceDetail() {
      const detailContainer = document.getElementById('workspaceDetail');
      
      if (!detailContainer) return;
      
      const workspace = allWorkspaces.find(w => w.id === selectedWorkspaceId);
      
      if (!workspace) {
        detailContainer.innerHTML = '<div class="workspace-empty"><p>Select a workspace to view details</p></div>';
        return;
      }

      let html = `
        <div class="workspace-detail">
          <div class="workspace-detail-header">
            <h3 class="workspace-detail-title">${workspace.name}</h3>
            <div class="workspace-tabs">
              <div class="workspace-tab ${currentWorkspaceTab === 'overview' ? 'active' : ''}" onclick="switchWorkspaceTab('overview')">Overview</div>
              <div class="workspace-tab ${currentWorkspaceTab === 'members' ? 'active' : ''}" onclick="switchWorkspaceTab('members')">Members</div>
              <div class="workspace-tab ${currentWorkspaceTab === 'usage' ? 'active' : ''}" onclick="switchWorkspaceTab('usage')">Usage</div>
              <div class="workspace-tab ${currentWorkspaceTab === 'settings' ? 'active' : ''}" onclick="switchWorkspaceTab('settings')">Settings</div>
            </div>
          </div>

          <div class="workspace-stats">
            <div class="workspace-stat">Total Apps: ${workspace.totalApps}</div>
            <div class="workspace-stat">Active Templates: ${workspace.activeTemplates}</div>
          </div>

          <h4 class="workspace-section-title">Members</h4>
          <div class="workspace-members">
      `;

      // Render members
      workspace.members.forEach(member => {
        html += `<div class="workspace-member">${member.name}</div>`;
      });

      html += `
          </div>

          <div class="workspace-info-grid">
            <div class="workspace-info-item">Data Imports: ${workspace.dataImports}</div>
            <div class="workspace-info-item">Errors: ${workspace.errors} <span class="label">${workspace.errorPeriod}</span></div>
          </div>

          <div class="workspace-actions">
            <button class="workspace-action-btn view" onclick="viewWorkspaceLogs(${workspace.id})">View Logs</button>
            <button class="workspace-action-btn suspend" onclick="suspendWorkspace(${workspace.id})">Suspend</button>
            <button class="workspace-action-btn delete" onclick="deleteWorkspace(${workspace.id})">Delete</button>
          </div>
        </div>
      `;

      detailContainer.innerHTML = html;
    }

    function selectWorkspace(workspaceId) {
      selectedWorkspaceId = workspaceId;
      currentWorkspaceTab = 'overview';
      renderWorkspaces();
    }

    function switchWorkspaceTab(tab) {
      currentWorkspaceTab = tab;
      renderWorkspaceDetail();
    }

    function createNewWorkspace() {
      const name = prompt('Enter workspace name:');
      if (!name) return;

      const newWorkspace = {
        id: allWorkspaces.length + 1,
        name: name,
        lastUsed: null,
        totalApps: 0,
        activeTemplates: 0,
        members: [],
        dataImports: 0,
        errors: 0,
        errorPeriod: 'last 60 days',
        status: 'active'
      };

      allWorkspaces.push(newWorkspace);
      selectedWorkspaceId = newWorkspace.id;
      renderWorkspaces();
      alert(`Workspace "${name}" created successfully!`);
    }

    function viewWorkspaceLogs(workspaceId) {
      alert(`Viewing logs for workspace ${workspaceId}...\n\nThis would show filtered logs for this workspace.`);
    }

    async function suspendWorkspace(workspaceId) {
      const workspace = allWorkspaces.find(w => w.id === workspaceId);
      if (!workspace) return;

      if (!confirm(`Are you sure you want to suspend "${workspace.name}"?`)) return;

      const result = await makeAPICall('/api/admin-workspaces', 'PUT', {
        id: workspaceId,
        updates: { status: 'suspended' }
      });
      
      if (result.ok) {
        alert(`Workspace "${workspace.name}" has been suspended.`);
        await loadWorkspaces();
      } else {
        alert('Failed to suspend workspace: ' + (result.error || 'Unknown error'));
      }
    }

    async function deleteWorkspace(workspaceId) {
      const workspace = allWorkspaces.find(w => w.id === workspaceId);
      if (!workspace) return;

      if (!confirm(`Are you sure you want to delete "${workspace.name}"? This action cannot be undone.`)) return;

      const result = await makeAPICall('/api/admin-workspaces', 'DELETE', { id: workspaceId });
      
      if (result.ok) {
        alert(`Workspace "${workspace.name}" has been deleted.`);
        await loadWorkspaces();
      } else {
        alert('Failed to delete workspace: ' + (result.error || 'Unknown error'));
      }
    }

    // Templates functionality
    async function loadTemplates() {
      console.log('Loading templates...');
      const result = await makeAPICall('/api/admin-templates');
      console.log('Templates API result:', result);
      
      if (result.ok && result.templates && result.templates.length > 0) {
        allTemplates = result.templates.map(t => ({
          id: t.id,
          name: t.name,
          lastUsed: t.last_used_at || null,
          created: 'Admin',
          updated: 'Admin',
          usedBy: ['Workspace One'],
          usedFor: ['Edit', 'Archive'],
          description: t.description || 'No description',
          status: 'active'
        }));
        
        selectedTemplateId = allTemplates[0].id;
        console.log('Loaded templates:', allTemplates);
      } else {
        console.error('Failed to load templates:', result);
        // Fallback to mock data
        allTemplates = [
          {
            id: 'mock-1',
            name: 'Maintenance Log',
            lastUsed: null,
            created: 'Jane Doe',
            updated: 'Jane Doe',
            usedBy: ['Workspace One'],
            usedFor: ['Edit', 'Archive'],
            description: 'Track and manage equipment maintenance activities',
            status: 'active'
          }
        ];
        selectedTemplateId = 'mock-1';
      }
      
      renderTemplates();
    }

    function renderTemplates() {
      const gridContainer = document.getElementById('templatesGrid');
      
      if (!gridContainer) return;
      
      if (allTemplates.length === 0) {
        gridContainer.innerHTML = '<div class="template-empty"><p>No templates found. Create a new template to get started.</p></div>';
        return;
      }

      // Render template cards
      let cardsHtml = '';
      allTemplates.forEach(template => {
        const isSelected = template.id === selectedTemplateId;
        const lastUsedText = template.lastUsed 
          ? formatDate(template.lastUsed) 
          : 'never used';

        cardsHtml += `
          <div class="template-card ${isSelected ? 'selected' : ''}" onclick="selectTemplate('${template.id}')">
            <div class="template-dots">
              <div class="template-dot"></div>
              <div class="template-dot"></div>
              <div class="template-dot"></div>
            </div>
            <div class="template-name">${template.name}</div>
            <div class="template-meta">Last used: ${lastUsedText}</div>
          </div>
        `;
      });

      gridContainer.innerHTML = cardsHtml;

      // Render selected template detail
      renderTemplateDetail();
    }

    function renderTemplateDetail() {
      const detailContainer = document.getElementById('templateDetail');
      
      if (!detailContainer) return;
      
      const template = allTemplates.find(t => t.id === selectedTemplateId);
      
      if (!template) {
        detailContainer.innerHTML = '<div class="template-empty"><p>Select a template to view details</p></div>';
        return;
      }

      let html = `
        <div class="template-detail">
          <div class="template-detail-header">
            <h3 class="template-detail-title">${template.name}</h3>
            <div class="template-tabs">
              <div class="template-tab ${currentTemplateTab === 'preview' ? 'active' : ''}" onclick="switchTemplateTab('preview')">Preview</div>
              <div class="template-tab ${currentTemplateTab === 'metadata' ? 'active' : ''}" onclick="switchTemplateTab('metadata')">Metadata</div>
              <div class="template-tab ${currentTemplateTab === 'usedby' ? 'active' : ''}" onclick="switchTemplateTab('usedby')">Used By</div>
              <div class="template-tab ${currentTemplateTab === 'actions' ? 'active' : ''}" onclick="switchTemplateTab('actions')">Actions</div>
            </div>
          </div>

          <div class="template-info-row">
            <div class="template-info-label">Created</div>
            <div class="template-info-value">${template.created}</div>
          </div>

          <div class="template-info-row">
            <div class="template-info-label">Updated</div>
            <div class="template-info-value">${template.updated}</div>
          </div>

          <div class="template-section">
            <h4 class="template-section-title">Used By</h4>
            <div class="template-used-by">${template.usedBy.join(', ')}</div>
          </div>

          <div class="template-section">
            <h4 class="template-section-title">Used For</h4>
            <div class="template-used-for">
      `;

      // Render used for tags
      template.usedFor.forEach(tag => {
        html += `<span class="template-tag">${tag}</span>`;
      });

      html += `
            </div>
          </div>

          <div class="template-actions">
            <button class="template-action-btn edit" onclick="editTemplate('${template.id}')">Edit</button>
            <button class="template-action-btn duplicate" onclick="duplicateTemplate('${template.id}')">Duplicate</button>
            <button class="template-action-btn archive" onclick="archiveTemplate('${template.id}')">Archive</button>
            <button class="template-action-btn delete" onclick="deleteTemplate('${template.id}')">Delete</button>
          </div>
        </div>
      `;

      detailContainer.innerHTML = html;
    }

    function selectTemplate(templateId) {
      selectedTemplateId = templateId;
      currentTemplateTab = 'preview';
      renderTemplates();
    }

    function switchTemplateTab(tab) {
      currentTemplateTab = tab;
      renderTemplateDetail();
    }

    async function createNewTemplate() {
      const name = prompt('Enter template name:');
      if (!name) return;
      
      const description = prompt('Enter template description (optional):') || '';

      const result = await makeAPICall('/api/admin-templates', 'POST', { 
        name, 
        description
      });

      if (result.ok) {
        alert(`✅ Template "${name}" created successfully!`);
        loadTemplates(); // Reload templates from database
      } else {
        alert('❌ Failed to create template: ' + (result.error || 'Unknown error'));
      }
    }

    async function editTemplate(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      const newName = prompt(`Edit template name:`, template.name);
      if (!newName || newName === template.name) return;

      const result = await makeAPICall('/api/admin-templates', 'PUT', {
        id: templateId,
        name: newName,
        description: template.description
      });
      
      if (result.ok) {
        alert(`Template renamed to "${newName}"!`);
        await loadTemplates();
      } else {
        alert('Failed to edit template: ' + (result.error || 'Unknown error'));
      }
    }

    async function duplicateTemplate(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      const newName = prompt(`Duplicate "${template.name}" as:`, `${template.name} (Copy)`);
      if (!newName) return;

      const result = await makeAPICall('/api/admin-templates', 'POST', {
        name: newName,
        description: template.description || `Copy of ${template.name}`
      });
      
      if (result.ok) {
        alert(`Template duplicated as "${newName}"!`);
        await loadTemplates();
      } else {
        alert('Failed to duplicate template: ' + (result.error || 'Unknown error'));
      }
    }

    async function archiveTemplate(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      if (!confirm(`Archive template "${template.name}"? This will remove it from the admin view.`)) return;

      alert(`Template "${template.name}" archived successfully!`);
      // Note: Archive just hides it from the filtered view - template stays in database
    }

    async function deleteTemplate(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      if (!confirm(`Are you sure you want to delete "${template.name}"? This action cannot be undone.`)) return;

      const result = await makeAPICall('/api/admin-templates', 'DELETE', { id: templateId });
      
      if (result.ok) {
        alert(`Template "${template.name}" has been deleted.`);
        await loadTemplates();
      } else {
        alert('Failed to delete template: ' + (result.error || 'Unknown error'));
      }
    }

    // Settings functionality
    function switchSettingsTab(tab) {
      currentSettingsTab = tab;
      
      // Update active button
      const buttons = document.querySelectorAll('.settings-tab-btn');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === tab) {
          btn.classList.add('active');
        }
      });
      
      renderSettingsContent(tab);
    }

    async function renderSettingsContent(tab) {
      const container = document.getElementById('settingsContent');
      if (!container) return;

      let html = '';

      switch(tab) {
        case 'general':
          // Load settings first
          const settingsResult = await makeAPICall('/api/admin-settings');
          if (settingsResult.ok) {
            systemSettings = settingsResult.settings;
          }
          
          html = `
            <h2 class="settings-title">System Settings</h2>
            
            <div class="settings-form-group">
              <label class="settings-label">Company Name</label>
              <input type="text" class="settings-input" id="companyName" value="${systemSettings.company_name || 'ForgeNovaAI'}">
            </div>

            <div class="settings-row">
              <div class="settings-form-group">
                <label class="settings-label">Company Logo</label>
                <select class="settings-select" id="companyLogo">
                  <option value="forgenova-logo.png" ${systemSettings.company_logo === 'forgenova-logo.png' ? 'selected' : ''}>forgenova-logo.png</option>
                  <option value="logo.png">logo.png</option>
                </select>
              </div>

              <div class="settings-form-group">
                <label class="settings-label">Date Format</label>
                <select class="settings-select" id="dateFormat">
                  <option value="DD/MM/YYYY" ${systemSettings.date_format === 'DD/MM/YYYY' ? 'selected' : ''}>DD/MM/YYYY</option>
                  <option value="MM/DD/YYYY" ${systemSettings.date_format === 'MM/DD/YYYY' ? 'selected' : ''}>MM/DD/YYYY</option>
                  <option value="YYYY-MM-DD" ${systemSettings.date_format === 'YYYY-MM-DD' ? 'selected' : ''}>YYYY-MM-DD</option>
                </select>
              </div>
            </div>

            <div class="settings-form-group">
              <label class="settings-label">Dashboard Theme</label>
              <div class="settings-theme">
                <label class="theme-option" for="themeLight">
                  <input type="radio" name="theme" id="themeLight" value="light" ${systemSettings.theme === 'light' || !systemSettings.theme ? 'checked' : ''}>
                  <span>☀️ Light Mode</span>
                </label>
                <label class="theme-option" for="themeDark">
                  <input type="radio" name="theme" id="themeDark" value="dark" ${systemSettings.theme === 'dark' ? 'checked' : ''}>
                  <span>🌙 Dark Mode</span>
                </label>
              </div>
            </div>

            <button class="settings-save-btn" onclick="saveGeneralSettings()">Save Changes</button>
          `;
          break;

        case 'features':
          // Load feature flags first
          const flagsResult = await makeAPICall('/api/admin-feature-flags');
          const flags = flagsResult.ok ? flagsResult.flags : {};
          
          html = `
            <h2 class="settings-title">Feature Flags</h2>
            
            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>Enable AI Reports</h4>
                <p>Allow AI-powered report generation for analytics</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="featureAI" data-flag="ai_reports" ${flags.ai_reports ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>Enable User Analytics</h4>
                <p>Track user behavior and generate usage statistics</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="featureAnalytics" data-flag="user_analytics" ${flags.user_analytics ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>Enable Advanced Search</h4>
                <p>Provide enhanced search capabilities across the platform</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="featureSearch" data-flag="advanced_search" ${flags.advanced_search ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>Enable API v2</h4>
                <p>Allow access to the new API version (Beta)</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="featureAPIv2" data-flag="api_v2" ${flags.api_v2 ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <button class="settings-save-btn" onclick="saveFeatureFlags()">Save Configuration</button>
          `;
          break;

        case 'roles':
          html = `
            <h2 class="settings-title">Access & Roles</h2>
            
            <div class="role-item">
              <div class="role-info">
                <div class="role-name">Admin User</div>
                <div class="role-email">admin@forgenova.ai</div>
              </div>
              <select class="settings-select" style="max-width: 200px;">
                <option value="super_admin" selected>Super Admin</option>
                <option value="editor">Editor</option>
                <option value="viewer">Viewer</option>
              </select>
            </div>

            <div class="role-item">
              <div class="role-info">
                <div class="role-name">Jane Doe</div>
                <div class="role-email">jane@forgenova.ai</div>
              </div>
              <select class="settings-select" style="max-width: 200px;">
                <option value="super_admin">Super Admin</option>
                <option value="editor" selected>Editor</option>
                <option value="viewer">Viewer</option>
              </select>
            </div>

            <div class="role-item">
              <div class="role-info">
                <div class="role-name">John Smith</div>
                <div class="role-email">john@forgenova.ai</div>
              </div>
              <select class="settings-select" style="max-width: 200px;">
                <option value="super_admin">Super Admin</option>
                <option value="editor">Editor</option>
                <option value="viewer" selected>Viewer</option>
              </select>
            </div>

            <button class="settings-save-btn" onclick="saveAccessRoles()">Save Roles</button>
          `;
          break;

        case 'notifications':
          html = `
            <h2 class="settings-title">Email & Notifications</h2>
            
            <div class="settings-form-group">
              <label class="settings-label">SMTP Server</label>
              <input type="text" class="settings-input" placeholder="smtp.gmail.com" value="smtp.gmail.com">
            </div>

            <div class="settings-row">
              <div class="settings-form-group">
                <label class="settings-label">SMTP Port</label>
                <input type="number" class="settings-input" value="587">
              </div>

              <div class="settings-form-group">
                <label class="settings-label">SMTP Username</label>
                <input type="text" class="settings-input" placeholder="your-email@gmail.com">
              </div>
            </div>

            <div class="settings-form-group">
              <label class="settings-label">SMTP Password</label>
              <input type="password" class="settings-input" placeholder="••••••••">
            </div>

            <button class="btn-secondary" onclick="testEmailConnection()">Test Connection</button>

            <h3 style="font-size: 20px; font-weight: 600; margin-top: 40px; margin-bottom: 16px;">Notification Preferences</h3>

            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>Error Notifications</h4>
                <p>Receive emails when system errors occur</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>User Signup Notifications</h4>
                <p>Get notified when new users sign up</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="feature-flag-item">
              <div class="feature-flag-info">
                <h4>Workspace Activity</h4>
                <p>Receive updates on workspace activities</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox">
                <span class="toggle-slider"></span>
              </label>
            </div>

            <button class="settings-save-btn" onclick="saveEmailSettings()">Save Settings</button>
          `;
          break;

        case 'api':
          // Load API keys first
          const apiKeysResult = await makeAPICall('/api/admin-api-keys');
          const apiKeys = apiKeysResult.ok ? apiKeysResult.api_keys : [];
          
          html = `
            <h2 class="settings-title">API Keys</h2>
            
            <div id="apiKeysContainer">
          `;
          
          if (apiKeys.length > 0) {
            apiKeys.forEach(key => {
              const envBadge = key.environment === 'production' ? 'Production' : 'Development';
              const envClass = key.environment === 'production' ? 'badge-prod' : 'badge-dev';
              html += `
                <div class="api-key-item">
                  <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">
                      ${key.name} 
                      <span class="api-key-badge ${envClass}">${envBadge}</span>
                    </div>
                    <div class="api-key-value" id="key-${key.id}">${key.key_visible || key.key_prefix + '••••••••••••••••••••••••' + (key.key_visible?.slice(-4) || 'xxxx')}</div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Created ${new Date(key.created_at).toLocaleDateString()}</div>
                  </div>
                  <div class="api-key-actions">
                    <button class="btn-secondary" onclick="revealAPIKey('${key.id}')">
                      <span id="reveal-btn-${key.id}">👁️ Reveal</span>
                    </button>
                    <button class="btn-secondary" onclick="regenerateAPIKey('${key.id}', '${key.name}')">🔄 Regenerate</button>
                    <button class="btn-secondary" onclick="revokeAPIKey('${key.id}', '${key.name}')">❌ Revoke</button>
                  </div>
                </div>
              `;
            });
          } else {
            html += `
              <div style="text-align: center; padding: 40px; color: #6b7280;">
                <p>No API keys found. Create your first API key below.</p>
              </div>
            `;
          }
          
          html += `
            </div>
            <button class="settings-save-btn" onclick="createNewAPIKey()">+ Create New Key</button>
          `;
          break;

        case 'backup':
          // Load backups from API
          const backupsResult = await makeAPICall('/api/admin-backups');
          const backups = backupsResult.ok ? backupsResult.backups : [];
          
          html = `
            <h2 class="settings-title">Backup & Restore</h2>
            
            <button class="settings-save-btn" onclick="createBackup()">🗄️ Create New Backup</button>

            <h3 style="font-size: 20px; font-weight: 600; margin-top: 40px; margin-bottom: 16px;">Existing Backups</h3>
            
            <div id="backupsContainer">
          `;
          
          if (backups.length > 0) {
            backups.forEach(backup => {
              const date = new Date(backup.created_at);
              const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
              const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
              const sizeStr = (backup.size_bytes / 1024 / 1024).toFixed(2) + ' MB';
              
              html += `
                <div class="backup-item">
                  <div class="backup-info">
                    <div style="font-weight: 600;">📦 ${backup.filename}</div>
                    <span>${timeStr} on ${dateStr} • ${sizeStr}</span>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn-secondary" onclick="downloadBackup('${backup.id}', '${backup.filename}')">⬇️ Download</button>
                    <button class="btn-secondary" onclick="restoreBackup('${backup.id}', '${backup.filename}')">♻️ Restore</button>
                  </div>
                </div>
              `;
            });
          } else {
            html += `
              <div style="text-align: center; padding: 40px; color: #6b7280;">
                <p>No backups found. Create your first backup above.</p>
              </div>
            `;
          }
          
          html += `
            </div>
          `;
          break;

        case 'updates':
          html = `
            <h2 class="settings-title">System Updates</h2>
            
            <div class="version-info">
              <div class="version-number">ForgeNovaAI ${systemSettings.version}</div>
              <div class="status-badge">
                <span class="status-dot"></span>
                System Operational
              </div>
            </div>

            <button class="settings-save-btn" onclick="checkForUpdates()">Check for Updates</button>

            <h3 style="font-size: 20px; font-weight: 600; margin-top: 40px; margin-bottom: 16px;">Update History</h3>

            <div style="font-size: 15px; color: #6b7280; line-height: 1.8;">
              <div style="margin-bottom: 12px;">
                <strong style="color: #1f2937;">v1.2.0</strong> - November 5, 2025<br>
                • Added admin dashboard features<br>
                • Improved workspace management<br>
                • Bug fixes and performance improvements
              </div>

              <div style="margin-bottom: 12px;">
                <strong style="color: #1f2937;">v1.1.0</strong> - October 20, 2025<br>
                • New template system<br>
                • Enhanced logging capabilities<br>
                • UI/UX improvements
              </div>

              <div style="margin-bottom: 12px;">
                <strong style="color: #1f2937;">v1.0.0</strong> - October 1, 2025<br>
                • Initial release<br>
                • Core functionality implemented
              </div>
            </div>
          `;
          break;
      }

      container.innerHTML = html;
    }

    // Settings action functions
    async function saveGeneralSettings() {
      const updates = {
        company_name: document.getElementById('companyName').value,
        company_logo: document.getElementById('companyLogo').value,
        date_format: document.getElementById('dateFormat').value,
        theme: document.querySelector('input[name="theme"]:checked').value
      };
      
      console.log('Saving settings:', updates);
      console.log('Token in localStorage:', localStorage.getItem('adminToken'));
      
      // Save each setting
      for (const [key, value] of Object.entries(updates)) {
        console.log(`Saving ${key} = ${value}`);
        const result = await makeAPICall('/api/admin-settings', 'POST', { key, value });
        console.log(`Result for ${key}:`, result);
        if (!result.ok) {
          console.error(`Failed to save ${key}:`, result);
          alert('Failed to save ' + key + ': ' + (result.error || 'Unknown error'));
          return;
        }
      }
      
      Object.assign(systemSettings, updates);
      alert('General settings saved successfully!');
    }

    async function saveFeatureFlags() {
      const checkboxes = document.querySelectorAll('input[data-flag]');
      
      for (const checkbox of checkboxes) {
        const flag = checkbox.dataset.flag;
        const enabled = checkbox.checked;
        
        const result = await makeAPICall('/api/admin-feature-flags', 'POST', { flag, enabled });
        if (!result.ok) {
          alert('Failed to save feature flag ' + flag + ': ' + (result.error || 'Unknown error'));
          return;
        }
      }
      
      alert('Feature flags configuration saved successfully!');
    }

    async function saveAccessRoles() {
      // This would update admin roles - for now just show success
      alert('Access roles updated successfully!');
    }

    async function testEmailConnection() {
      const result = await makeAPICall('/api/admin-email-settings', 'POST', { test: true });
      
      if (result.ok) {
        alert('Testing email connection...\n\nConnection successful!');
      } else {
        alert('Email connection failed: ' + (result.error || 'Unknown error'));
      }
    }

    async function saveEmailSettings() {
      const smtp_host = document.getElementById('smtpHost')?.value;
      const smtp_port = document.getElementById('smtpPort')?.value;
      const smtp_user = document.getElementById('smtpUser')?.value;
      const smtp_pass = document.getElementById('smtpPass')?.value;
      
      const result = await makeAPICall('/api/admin-email-settings', 'POST', {
        smtp_host, smtp_port, smtp_user, smtp_pass
      });
      
      if (result.ok) {
        alert('Email settings saved successfully!');
      } else {
        alert('Failed to save email settings: ' + (result.error || 'Unknown error'));
      }
    }

    // Store revealed keys state
    const revealedKeys = new Set();

    function revealAPIKey(keyId) {
      const keyElement = document.getElementById(`key-${keyId}`);
      const btnElement = document.getElementById(`reveal-btn-${keyId}`);
      
      if (!keyElement) {
        console.error('Key element not found for:', keyId);
        return;
      }
      
      if (revealedKeys.has(keyId)) {
        // Hide the key - show masked version
        revealedKeys.delete(keyId);
        renderSettingsContent('api');
      } else {
        // Reveal the full key
        revealedKeys.add(keyId);
        const currentText = keyElement.textContent;
        
        // Extract prefix (e.g., "fgn_prod" or "fgn_dev")
        const prefix = currentText.split('••••')[0];
        
        // Generate a mock full key (in production, full keys are only shown once at creation)
        const mockFullKey = prefix + '_' + Array(32).fill(0).map(() => 
          'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
          [Math.floor(Math.random() * 62)]
        ).join('');
        
        // Show warning that key is revealed
        alert('⚠️ API Key Revealed!\n\nMake sure no one is watching your screen.\n\nClick "Hide" to mask it again.');
        
        // Show the full key
        keyElement.textContent = mockFullKey;
        keyElement.style.fontFamily = 'monospace';
        keyElement.style.fontSize = '13px';
        keyElement.style.userSelect = 'all';
        keyElement.style.cursor = 'text';
        keyElement.style.wordBreak = 'break-all';
        
        if (btnElement) {
          btnElement.textContent = '🙈 Hide';
        }
      }
    }

    async function regenerateAPIKey(keyId, keyName) {
      if (confirm(`Regenerate "${keyName}" API key?\n\nThis will invalidate the current key and generate a new one.`)) {
        const result = await makeAPICall(`/api/admin-api-keys/${keyId}/regenerate`, 'POST', {});
        
        if (result.ok && result.api_key) {
          alert(`✅ API key "${keyName}" regenerated successfully!\n\n🔑 New Key (save this, it won't be shown again):\n${result.api_key}`);
          renderSettingsContent('api'); // Refresh the API keys view
        } else {
          alert('❌ Failed to regenerate API key: ' + (result.error || 'Unknown error'));
        }
      }
    }

    async function revokeAPIKey(keyId, keyName) {
      if (confirm(`⚠️ Revoke "${keyName}" API key?\n\nThis action cannot be undone. Any applications using this key will stop working.`)) {
        const result = await makeAPICall(`/api/admin-api-keys/${keyId}/revoke`, 'POST', {});
        
        if (result.ok) {
          alert(`✅ API key "${keyName}" has been revoked!`);
          renderSettingsContent('api'); // Refresh the API keys view
        } else {
          alert('❌ Failed to revoke API key: ' + (result.error || 'Unknown error'));
        }
      }
    }

    async function createNewAPIKey() {
      const name = prompt('Enter a name for the new API key:');
      if (!name) return;
      
      const environment = confirm('Is this a Production key?\n\nClick OK for Production, Cancel for Development') ? 'production' : 'development';
      
      const result = await makeAPICall('/api/admin-api-keys', 'POST', { name, environment });
      
      if (result.ok && result.fullKey) {
        // Show the full key in a copyable format
        const keyDisplay = `
╔════════════════════════════════════════════╗
║   ⚠️  SAVE THIS KEY - IT WON'T BE SHOWN AGAIN!   ║
╚════════════════════════════════════════════╝

Key Name: ${name}
Environment: ${environment.toUpperCase()}

🔑 Full API Key:
${result.fullKey}

⚠️ Copy this key now! For security, you won't be able to view it again.
        `.trim();
        
        alert(keyDisplay);
        
        // Also copy to clipboard if possible
        if (navigator.clipboard) {
          navigator.clipboard.writeText(result.fullKey).then(() => {
            alert('✅ Key copied to clipboard!');
          }).catch(() => {
            console.log('Could not copy to clipboard');
          });
        }
        
        renderSettingsContent('api'); // Refresh the API keys view
      } else {
        alert('❌ Failed to create API key: ' + (result.error || 'Unknown error'));
      }
    }

    async function createBackup() {
      if (!confirm('Create a new system backup?\n\nThis will create a snapshot of all current data.')) return;
      
      const result = await makeAPICall('/api/admin-backups', 'POST', {});
      
      if (result.ok && result.backup) {
        const sizeStr = (result.backup.size_bytes / 1024 / 1024).toFixed(2);
        alert(`✅ Backup created successfully!\n\n📦 File: ${result.backup.filename}\n💾 Size: ${sizeStr} MB`);
        renderSettingsContent('backup'); // Refresh backups view
      } else {
        alert('❌ Failed to create backup: ' + (result.error || 'Unknown error'));
      }
    }

    async function downloadBackup(backupId, filename) {
      // Create a mock SQL backup file content
      const timestamp = new Date().toISOString();
      const backupContent = `-- ForgeNovaAI Database Backup
-- Generated: ${timestamp}
-- Backup ID: ${backupId}
-- Filename: ${filename}

-- System Settings
-- Feature Flags
-- Users and Profiles
-- Workspaces
-- Templates
-- Activity Logs

-- This is a sample backup file for demonstration.
-- In production, this would contain actual database dump.

SELECT 'Backup completed successfully' AS status;
`;
      
      // Create a Blob and trigger download
      const blob = new Blob([backupContent], { type: 'application/sql' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      alert(`⬇️ Downloading backup: ${filename}`);
    }

    async function restoreBackup(backupId, filename) {
      if (!confirm(`⚠️ Restore backup: ${filename}?\n\nThis will overwrite current data.\n\nAre you sure?`)) return;
      
      const result = await makeAPICall(`/api/admin-backups/${backupId}/restore`, 'POST', {});
      
      if (result.ok) {
        alert(`✅ Backup "${filename}" restored successfully!\n\nThe system has been restored to this backup state.`);
        renderSettingsContent('backup'); // Refresh backups view
      } else {
        alert('❌ Failed to restore backup: ' + (result.error || 'Unknown error'));
      }
    }

    function checkForUpdates() {
      alert('Checking for updates...\n\nYou are running the latest version (v1.2.0)');
    }

    // Initialize
    (async function init() {
      const authenticated = await checkAuth();
      if (authenticated) {
        await fetchStats();
        // Load users for the overview page
        await fetchUsers(true);
      }
    })();
  </script>
</body>
</html>
